# Todolist 运维手册

## 架构概览
- 前端：Next.js 14（默认端口 5173，可通过 `FRONTEND_PORT` 覆盖）
- 后端：FastAPI + Uvicorn（默认端口 8000，可通过 `API_PORT` 覆盖），SQLite 本地文件 todos.db
- 跨域：FastAPI 已开启 CORS

## 环境准备
- Node.js ≥ 18，npm
- Python ≥ 3.11
- 脚本会自动：
  - 创建/复用 backend/.venv 并安装 `requirements.txt`
  - 在 frontend 目录执行 `npm install`
- 若目标环境无外网，请提前在本地准备离线依赖包

## 启动与停止
- 开发环境：`./start.sh dev`
  - 自动安装依赖，后端监听 `${API_PORT:-8000}`，前端监听 `${FRONTEND_PORT:-5173}`
  - 日志输出至 `logs/backend.log`、`logs/frontend.log`
- 生产环境：`./start.sh prod`
  - 先构建前端，再以 2 worker 启动后端
- 自定义端口：`API_PORT=9000 FRONTEND_PORT=4000 ./start.sh dev`
- 查看状态：`./start.sh status`
- 停止服务：`./start.sh stop`

## 目录与文件
- 数据库：todos.db（项目根目录）
- 日志目录：logs/backend.log, logs/frontend.log
- PID 文件：.pids/backend.pid, .pids/frontend.pid

## 配置项
- 端口：
  - 后端默认 8000，可通过环境变量 `API_PORT` 覆盖（脚本自动传入 uvicorn）
  - 前端默认 5173，可通过环境变量 `FRONTEND_PORT` 覆盖（脚本自动传入 npm 命令）
  - 如需永久修改，可在 `start.sh` 中调整默认值或变更前端脚本端口
- 数据库路径：backend/app.py:18 使用 ROOT/todos.db，可通过环境变量实现重定向（需要改造代码）

## 健康检查
- 后端健康接口：GET http://localhost:8000/api/health（app.py:90）
- 前端健康：访问主页或检查进程端口可用性

## 备份与恢复
- SQLite 备份：
  - 停止服务：./start.sh stop
  - 复制文件：cp todos.db todos.db.bak-$(date +%F)
- 恢复：
  - 停止服务并替换文件：cp todos.db.bak-YYYY-MM-DD todos.db

## 日志与排障
- 查看后端日志：tail -f logs/backend.log
- 查看前端日志：tail -f logs/frontend.log
- 常见问题：
  - 后端报 uvicorn 不存在：确保 backend/.venv 已安装 requirements.txt
  - 前端 5173 端口冲突：修改 package.json 的端口或停止占用进程
  - 数据库迁移：首次启动自动创建/补全表结构（backend/app.py:52-88）

## 安全加固建议（基础）
- 前端、后端端口仅在内网暴露；对外使用反向代理并开启 HTTPS
- 将 allow_origins 收敛为受信域名（backend/app.py:10-16）
- 定期备份 todos.db 并限制文件权限（chmod 600 todos.db）

## 部署建议
- 使用进程管理：systemd 或 PM2（前端）
- 反向代理：Nginx/Traefik，将 /api/* 转发到 8000，其余到 5173 或前端静态产物
