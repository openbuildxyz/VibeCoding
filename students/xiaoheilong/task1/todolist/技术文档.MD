# Todolist 网站项目技术设计（MVP）

## 概述
依据《需求文档.MD》，本技术设计定义系统架构、技术栈、接口契约、数据模型、校验与安全、错误处理、分页/筛选/排序实现、测试与部署方案，确保前后端一致性与可维护性。

## 架构
- 前端：Next.js（App Router），SSR/CSR 结合，列表/详情/表单页面；统一数据获取与接口访问层。
- 后端：REST API（CRUD，FastAPI），分层（路由/控制器/服务/数据访问），统一错误处理与日志。
- 数据库：本地持久化（MVP 采用 SQLite），可平滑切换到其他关系型数据库。
- 通信：JSON over HTTP，CORS 开启。

```
[Next.js] <--> [HTTP/JSON API(FastAPI)] <--> [Service Layer] <--> [Repository/SQLAlchemy] <--> [SQLite]
```

## 技术栈（建议）
- 前端：Next.js 14+（App Router）+ TypeScript，React Query/TanStack Query（数据获取/缓存），Axios/Fetch（HTTP 客户端），轻量 UI 组件库（如 Tailwind/Headless UI）。
- 后端：Python 3.11+，FastAPI，Pydantic（schema 校验），SQLAlchemy/SQLModel，Alembic（迁移），Uvicorn（ASGI 服务器），SQLite。
- 开发辅助：ESLint + Prettier（前端）、ruff/flake8 + black（后端，可选），dotenv。
- 安全与中间件：FastAPI CORSMiddleware，slowapi/限流器（速率限制，可选）。
- 日志：标准 logging + uvicorn 日志；结构化日志可引入 loguru（可选）。

## 环境变量
- FRONTEND_PORT=5173
- API_PORT=8000
- DATABASE_URL="sqlite:///./todolist.db"（SQLite；若使用 SQLModel/SQLAlchemy）
- PYTHON_ENV=development|production

## 数据模型
- Todo
  - id: int（自增）或 UUID（若采用 UUID 字段）
  - title: string (≤100)
  - description?: string (≤1000)
  - status: 'todo' | 'in_progress' | 'done'
  - dueDate?: string (ISO8601)
  - priority: 'low' | 'medium' | 'high'
  - createdAt: string (ISO8601)
  - updatedAt: string (ISO8601)

SQL（SQLite）
```
CREATE TABLE IF NOT EXISTS todos (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  description TEXT,
  status TEXT NOT NULL CHECK (status IN ('todo','in_progress','done')),
  due_date TEXT,
  priority TEXT NOT NULL CHECK (priority IN ('low','medium','high')),
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);
CREATE INDEX IF NOT EXISTS idx_todos_status ON todos(status);
CREATE INDEX IF NOT EXISTS idx_todos_priority ON todos(priority);
CREATE INDEX IF NOT EXISTS idx_todos_created_at ON todos(created_at DESC);
```

## API 契约（FastAPI）
- 基本约定
  - Content-Type: application/json
  - 错误统一格式：`{ error: { code: string, message: string, details?: any } }`
  - OpenAPI：FastAPI 自动生成 `/docs` 与 `/openapi.json`（生产可限制暴露）

- POST /api/todos
  - req body: `{ title, description?, status?, dueDate?, priority? }`
  - 校验：Pydantic 模型验证；title 必填，长度限制；枚举合法；dueDate 为 ISO 字符串
  - resp 201: `Todo`

- GET /api/todos
  - query: `{ page?, pageSize?, sortBy?=createdAt, sortOrder?=desc, status?, priority?, q? }`
  - 过滤：status/priority 精确匹配；q 在 title/description LIKE；分页与排序服务端执行
  - resp 200: `{ items: Todo[], page, pageSize, total }`

- GET /api/todos/{id}
  - resp 200: `Todo`
  - 404：未找到

- PATCH /api/todos/{id}
  - req body: 局部字段（Pydantic 模型 `exclude_unset=True`）
  - 并发控制（建议）：若提供 `If-Unmodified-Since: <updatedAt>`，服务端比较，冲突返回 409
  - resp 200: 更新后的 `Todo`

- DELETE /api/todos/{id}
  - resp 204（无内容）

## 校验与安全（防御性）
- 输入校验：Pydantic 模型（Body/Query/Path）+ 额外长度与枚举白名单校验。
- SQL 注入防护：SQLAlchemy/SQLModel 参数化查询；禁止拼接 SQL。
- 输出编码：返回 JSON 文本在前端渲染时进行转义；后端避免返回未清洗的富文本。
- 速率限制：slowapi（如每 IP 100 req/15min），关键写操作更严格。
- 安全头：可用 Starlette 中间件/自定义中间件配置安全头。
- CORS：仅允许可信来源（开发期可为 *，生产期设白名单）。
- 错误不泄漏：开发环境可返回详细；生产屏蔽栈信息。

## 错误处理
- 统一异常处理：捕获 `RequestValidationError`、自定义业务异常，映射到统一错误对象和 HTTP 状态码。
- 错误码示例：
  - `VALIDATION_ERROR` 400
  - `NOT_FOUND` 404
  - `CONFLICT` 409
  - `RATE_LIMITED` 429
  - `INTERNAL_ERROR` 500

## 分页/筛选/排序实现
- 分页：`page`（默认 1），`pageSize`（默认 20，上限 100），`OFFSET (page-1)*pageSize LIMIT pageSize`。
- 排序：`sortBy ∈ {createdAt, updatedAt, dueDate, priority}`，`sortOrder ∈ {asc, desc}`；白名单防止任意列排序。
- 搜索：`q` 使用 `LIKE %q%` 匹配 title/description；对 `q` 做长度与字符集限制。

## 前端设计要点（Next.js）
- 路由：App Router 下的 `app/` 目录，列表页（分页/筛选/搜索）、创建/编辑表单、详情（可用动态路由）。
- 数据获取：React Query；封装 hooks（useTodosList/useTodoDetail），查询键包含分页/筛选参数；乐观更新与失效刷新。
- 状态管理：以 Query 驱动为主；必要时使用 Context/轻量状态库。
- 表单：React Hook Form + Zod/Yup；后端错误展示于字段或全局提示。
- 交互：加载骨架；空态；删除二次确认；状态快捷切换（乐观更新 + 失败回滚）。

## 后端分层与目录结构（FastAPI 示例）
- backend/
  - app/
    - main.py（应用启动、注册路由与中间件）
    - api/
      - deps.py（依赖注入/DB 会话）
      - routers/
        - todos.py（路由定义与请求/响应模型）
    - core/
      - config.py（设置/环境变量）
      - security.py（CORS/限流配置）
      - errors.py（统一异常与错误响应）
    - services/
      - todos.py（业务逻辑）
    - db/
      - base.py（Base/Session/Engine 初始化）
      - models.py（SQLAlchemy/SQLModel 定义）
      - crud_todos.py（数据访问：分页/筛选/增删改查）
      - migrations/（Alembic 迁移）
    - schemas/
      - todo.py（Pydantic 模型：Create/Update/Read）
    - logging.py（日志配置）

## 并发与一致性
- 时间戳版本控制：更新时携带客户端持有的 `updatedAt`（或 ETag），服务端比对不一致返回 409。
- 事务：多字段更新使用 SQLAlchemy 事务保证原子性。

## 日志与监控
- 访问日志：uvicorn 访问日志，或 Starlette 中间件记录方法/路径/状态码/耗时/请求 ID。
- 错误日志：捕获并记录错误码、堆栈（开发环境）、关联请求 ID。
- 健康检查：`GET /api/health` 返回 `{ status: 'ok' }`。

## 测试策略
- 后端：
  - 单元测试：服务与仓储层（创建/更新/删除/分页逻辑），pytest。
  - 集成测试：FastAPI TestClient 覆盖路由/校验/错误处理（使用临时 SQLite）。
- 前端：
  - 组件测试：Vitest/Jest + React Testing Library。
  - E2E（可选）：Playwright/Cypress 走创建→列表→更新→删除。

## 构建与运行（示例）
- 后端（FastAPI）
  - 安装：`python -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt`
  - 开发：`uvicorn app.main:app --reload --port $API_PORT`
  - 迁移：`alembic upgrade head`
- 前端（Next.js）
  - 安装：`pnpm install` 或 `npm install`
  - 开发：`pnpm dev`（Next.js，端口 `FRONTEND_PORT`）
  - 构建：`pnpm build && pnpm start`（或使用 `next start`），产物位于 `.next/`

## 部署（MVP）
- 单机：前后端分别运行；Nginx 反向代理（/api 转发至 FastAPI；其余静态资源由前端构建产物提供）。
- Docker（可选）：
  - backend：python:slim 基础镜像，复制源码，安装依赖，运行 uvicorn 暴露 `API_PORT`
  - frontend：node 构建静态产物，nginx/静态服务器提供

## 风险与扩展
- 多用户与鉴权：未来可引入 OAuth/JWT，为 Todo 绑定 ownerId。
- 高并发：迁移至云数据库与连接池；增加缓存层（Redis）与索引优化。
- 审计与可观测性：接入结构化日志、APM/OTel、告警。

## 里程碑与验收
- M1：后端 CRUD + 校验 + 分页/筛选/排序 + 错误处理（FastAPI + SQLAlchemy/SQLModel + Alembic）
- M2：前端列表/详情/表单 + 状态快捷切换 + 删除确认（Vue + Vite + TanStack Query/Pinia）
- M3：本地缓存与重试、基础测试、健康检查